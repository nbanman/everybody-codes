use std::{collections::HashSet, iter::successors};

use everybody_codes::coord::Coord;

fn main() {
    println!("1. {}", solve(1, false));
    println!("2. {}", solve(2, false));
    println!("3. {}", solve(3, true));
}

fn solve(part: usize, diagonals: bool) -> usize {
    let input = get_input(part - 1);
    let width = input.find(|it| it == '\n').unwrap() + 1;
    let blocks: HashSet<Coord<i16, 2>> = input.as_bytes().into_iter()
        .enumerate()
        .filter(|(_, &c)| c == b'#') 
        .map(|(idx, _)| {
            let x = (idx % width) as i16;
            let y = (idx / width) as i16;
            Coord::new2d(x, y)
        }).collect();
    let dig = |blocks: &HashSet<Coord<i16, 2>>| -> HashSet<Coord<i16, 2>> {
        blocks.iter()
            .filter(|block| { 
                block.adjacent(diagonals).iter()
                    .all(|pos| blocks.contains(pos))
            }).cloned()
            .collect()
    };
    let stages = successors(Some(blocks), |blocks| {
        let next = dig(blocks);
        if next.is_empty() {
            None
        } else {
            Some(next)
        }
    });
    stages
        .fold(0, |count, stage| {
            count + stage.len()
        })

}

fn get_input(part: usize) -> &'static str {
    let inputs = [
        r"..............................
..............................
..............................
..............#...............
..........##.#######..........
..........##########..........
........#############.........
.........#############........
...........##########.........
............####.#####........
..............##.####.........
..............#...#...........
..................#...........
..............................",
        r"......................................................................
......................................................................
..............................#.......................................
.............................###....##................................
..............................########................................
.............................#########................................
............................############..............................
............................#################.........................
............................##################........................
.......................##.####################........................
.......................######################.........................
......................#######################.........................
.....................#########################........................
...................###############################....................
..................################################....................
...................##############################.....................
....................##############################....................
....................###############..#############....................
.....................##############################...................
.....................################################.................
......................###############################.................
.....................#############################....................
.....................#############################....................
.....................#############################....................
.....................#.##########################.....................
....................##.#########################......................
....................##..####################.##.......................
........................###################..#........................
........................##################............................
.........................#################............................
..........................###############.............................
.........................##############...............................
.............................############.............................
............................##.#########..............................
......................................................................",
        r"######################........................................................................................................################
#.#####################.......................................................................................................##############.#
#######################......................................#..#..............................................................###############
#######################.....................................##########..#..#...................................................###############
######################.#....................................#########..#####.................................................#.###############
######################.#................................##..##################..............................................##################
#########################..............................########################...............................................################
#######################.............................#..##########################...#.........................................################
###################.###.............................#.###############################.........................................################
###################.##.............................##.###############################.........................................################
#################...................................################################.........................................#################
#################....................................###############################...###..................................##################
##################..................................##########################################...............................#################
##################..................................##########################################................................################
####################.................................#########################################................................################
###################................................###########################################.................................#..############
##################..................................#########################################..................................#.#############
###############...................................###########################################...................................##############
##############.....................................###########################################.......................................########.
..############......................................##..######################################........................................###.....
..#####.######.........................................######################################.......................................####......
...##########........................................##########################################....................................####.......
...##.#....#........................................###########################################...............................................
...................................................##################......###################................................................
.................................................###################.######.######################............................................
..................................................#################.###..###.####################.............................................
...................................................###.############.###..###.######################...........................................
...................................................#################.######.#######################..........................................#
......................................................###############......###################..####.........................................#
.....................................................#########################################...####..................................##..###
....................................................#########################################.#.####....................................######
...#................................................##############################################...............................#..###.######
..###...............................................#############################################..............................###.#.#########
..####..............................................##############################################.............................###############
#####....##............................................##########################################................................#############
#####..###.............................................###########################################............................#..#############
#############...........................................##########################################............................#.##############
###############...........................................########################################............................################
##############..........................................##########################################..........................##################
#############...........................................#.#.#######################################........................###################
##############...............................................#######################################........................##################
###############................................................###################################.##.....................####################
################...............................................##############################...#####......................###################
#################.............................................##########################..###....#.#.......................###################
#################.............................................###############################.............................####################
################.................................................#############################...........................#####################
###############...................................................#######################....#...........................#####################
###############..................................................######################..................................###.#################
###############....................................................###################......................................##################
################.....................................................#######.#..#####........................................#################
#.#################....................................................##########..##........................................###############.#
################........................................................#.....##...#.........................................#################",
    ];
    inputs[part]
}

#[test]
fn default() {
    assert_eq!(134, solve(1, false));
    assert_eq!(2810, solve(2, false));
    assert_eq!(10443, solve(3, true));
}